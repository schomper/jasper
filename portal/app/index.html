<!DOCTYPE html>
<html ng-app="portalApp">
    <head>
        <meta charset="utf-8">
        <title>Portal</title>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.10/angular.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.10/angular-route.min.js"></script>
        <script>
            var portalApp = angular.module('portalApp', ['ngRoute']);

            /* Runs ones at the start of the app */
            portalApp.config(function($routeProvider){
                $routeProvider.
                    when('/', {
                        templateUrl: 'article-list.html',
                        controller: 'ArticleListCtrl'
                    }).
                    when('/:articleName', {
                        templateUrl: 'article-detail.html',
                        controller: 'ArticleDetailCtrl'
                    }).
                    otherwise({
                        redirectTo: '/'            
                    });
            });

            /* Create our own dependancy injection          *
             * removes the need to load data multiple times */
            portalApp.factory('articles', function($http){
                
                function getData(callback) { 
                    $http({
                        method: 'GET',
                        url: 'articles.json',
                        cache: true
                    }).success(callback);
                }

                return {
                    list: getData,
                    find: function(name, callback) {
                        getData(function(data) {
                            var article = data.filter(function(entry){
                                return entry.name === name;    
                            })[0];
                            callback(article);
                        });
                    }
                };
            });

            portalApp.controller('ArticleListCtrl', function($scope, articles) {
                articles.list(function(articles) {
                    $scope.articles = articles;
                });
            });

            portalApp.controller('ArticleDetailCtrl', function($scope, $routeParams, articles) {
                $scope.name = $routeParams.articleName;

                articles.find($routeParams.articleName, function(article) {
                    $scope.article = article;                    
                });
            });

            // Custom filter
            portalApp.filter('encodeURI', function() {
                return window.encodeURI;    
            });
        </script>   
    </head>

    <body>
        <div ng-view></div>
    </body>
</html>
